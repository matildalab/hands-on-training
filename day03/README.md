# Efficient Data Loading

## Gradient Accumulation
The gradient accumulation value must be at least `2 * ipus_per_replica - 1`.
In this case, model is pipelined over 2 IPUs:
```python
model = torchvision.models.resnet101()
model.layer3[8] = poptorch.BeginBlock(model.layer3[8], ipu_id=1)
```
So `ipus_per_replica=2`, meaning that gradient accumulation must be at least 3.
```bash
$ python main.py --gradient-accumulation 3
Namespace(async_dataloader=False, batch_size=32, device_iterations=1, eight_bit_io=False, epochs=5, gradient_accumulation=3, precision='16.16', replicas=1)
Files already downloaded and verified
Graph compilation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [07:25<00:00]
[Epoch 01]: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████| 520/520 [08:35<00:00,  1.01it/s, Loss=1.11]
[Epoch 01] loss = 1.751
[Epoch 02]: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████| 520/520 [00:53<00:00,  9.75it/s, Loss=1.14]
[Epoch 02] loss = 1.278
[Epoch 03]: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████| 520/520 [00:53<00:00,  9.76it/s, Loss=0.958]
[Epoch 03] loss = 1.044
[Epoch 04]: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████| 520/520 [00:53<00:00,  9.76it/s, Loss=0.613]
[Epoch 04] loss = 0.861
[Epoch 05]: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████| 520/520 [00:53<00:00,  9.76it/s, Loss=0.535]
[Epoch 05] loss = 0.737
```
Increasing gradient accumulation results in higher throughput and more samples per weight update.
```bash
$ python main.py --gradient-accumulation 8
Namespace(async_dataloader=False, batch_size=32, device_iterations=1, eight_bit_io=False, epochs=5, gradient_accumulation=8, precision='16.16', replicas=1)
Files already downloaded and verified
Graph compilation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [07:26<00:00]
[Epoch 01]: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████| 195/195 [08:29<00:00,  2.61s/it, Loss=1.53]
[Epoch 01] loss = 1.817
[Epoch 02]: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████| 195/195 [00:49<00:00,  3.93it/s, Loss=1.19]
[Epoch 02] loss = 1.392
[Epoch 03]: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████| 195/195 [00:49<00:00,  3.92it/s, Loss=1.04]
[Epoch 03] loss = 1.156
[Epoch 04]: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████| 195/195 [00:49<00:00,  3.92it/s, Loss=0.844]
[Epoch 04] loss = 1.022
[Epoch 05]: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████| 195/195 [00:49<00:00,  3.93it/s, Loss=0.824]
[Epoch 05] loss = 0.864
```

## Device Iterations
```bash
$ python main.py --gradient-accumulation 8 --device-iterations 4
Namespace(async_dataloader=False, batch_size=32, device_iterations=4, eight_bit_io=False, epochs=5, gradient_accumulation=8, precision='16.16', replicas=1)
Files already downloaded and verified
Graph compilation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [07:26<00:00]
[Epoch 01]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [08:27<00:00, 10.56s/it, Loss=1.46]
[Epoch 01] loss = 1.794
[Epoch 02]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:46<00:00,  1.02it/s, Loss=0.96]
[Epoch 02] loss = 1.344
[Epoch 03]: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:46<00:00,  1.02it/s, Loss=0.856]
[Epoch 03] loss = 1.127
[Epoch 04]: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:46<00:00,  1.02it/s, Loss=0.938]
[Epoch 04] loss = 0.950
[Epoch 05]: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:46<00:00,  1.02it/s, Loss=0.804]
[Epoch 05] loss = 0.826
```

## 8-bit I/O
```bash
$ python main.py --gradient-accumulation 8 --device-iterations 4 --eight-bit-io
Namespace(async_dataloader=False, batch_size=32, device_iterations=4, eight_bit_io=True, epochs=5, gradient_accumulation=8, precision='16.16', replicas=1)
Files already downloaded and verified
Graph compilation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [07:26<00:00]
[Epoch 01]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [07:56<00:00,  9.93s/it, Loss=1.42]
[Epoch 01] loss = 1.769
[Epoch 02]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:15<00:00,  3.06it/s, Loss=1.11]
[Epoch 02] loss = 1.345
[Epoch 03]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:15<00:00,  3.06it/s, Loss=1.18]
[Epoch 03] loss = 1.130
[Epoch 04]: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:15<00:00,  3.06it/s, Loss=0.835]
[Epoch 04] loss = 0.989
[Epoch 05]: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:15<00:00,  3.06it/s, Loss=0.888]
[Epoch 05] loss = 0.887
```

## Asynchronous Data Loading
```bash
$ python main.py --gradient-accumulation 8 --device-iterations 4 --eight-bit-io --async-dataloaderNamespace(async_dataloader=True, batch_size=32, device_iterations=4, eight_bit_io=True, epochs=5, gradient_accumulation=8, precision='16.16', replicas=1)Files already downloaded and verified
Graph compilation: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [07:25<00:00]
[Epoch 01]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [07:47<00:00,  9.74s/it, Loss=1.52]
[Epoch 01] loss = 1.788
[Epoch 02]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:08<00:00,  5.62it/s, Loss=1.17]
[Epoch 02] loss = 1.333
[Epoch 03]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:08<00:00,  5.60it/s, Loss=1.07]
[Epoch 03] loss = 1.174
[Epoch 04]: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:08<00:00,  5.73it/s, Loss=1.15]
[Epoch 04] loss = 1.033
[Epoch 05]: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 48/48 [00:08<00:00,  5.78it/s, Loss=0.842]
[Epoch 05] loss = 0.869
```